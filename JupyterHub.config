# JupyterHub configuration
c.JupyterHub.bind_url = 'http://0.0.0.0:8000'  # Bind to all interfaces
c.JupyterHub.hub_ip = '127.0.0.1'  # Hub IP
c.JupyterHub.port = 443
c.JupyterHub.ssl_cert = '/etc/letsencrypt/live/FQDN/fullchain.pem'
c.JupyterHub.ssl_key = '/etc/letsencrypt/live/FQDN/privkey.pem'


# Built-in PAM Authenticator configuration (no extra import/package needed)
c.JupyterHub.authenticator_class = 'jupyterhub.auth.PAMAuthenticator'
c.PAMAuthenticator.service = 'login'  # Use the system's login service for PAM (leverages OS LDAP via PAM)
c.SystemdSpawner.extra_systemd_environment = {
    'PAM_TYPE': 'login'
}

# Optional: Additional PAM settings if needed (e.g., for session handling)
# c.PAMAuthenticator.open_sessions = False  # Disable opening PAM sessions (useful if causing issues)
# c.PAMAuthenticator.encoding = 'utf8'     # Encoding for PAM interactions

# Spawner settings (use systemdspawner for system users)
c.JupyterHub.spawner_class = 'systemdspawner.SystemdSpawner'
c.SystemdSpawner.mem_limit = '20G'  # Memory limit per user
c.SystemdSpawner.cpu_limit = 2.0  # CPU limit per user
# 2 CPUs per user is the max given that upto 14 users could be on one VM
# 20 GB RAM per user max - could go to 30-32 MAX.

# Path to Jupyter Notebook in Mamba environment
c.Spawner.cmd = ['/opt/miniforge3/envs/jupyterhub/bin/jupyterhub-singleuser']

## Additional ##
c.Authenticator.allow_all = True

# ==============================
# Safe pre-spawn hook for home directories (FIXED VERSION)
# Works 100% on Ubuntu, GCP, AWS, Azure, Oracle, etc.
# ==============================

import os
import pwd
import subprocess
from jupyterhub.spawner import Spawner

def safe_ensure_home_dir(spawner: Spawner):
    username = spawner.user.name
    try:
        pw_record = pwd.getpwnam(username)
        home = pw_record.pw_dir
        uid = pw_record.pw_uid
        gid = pw_record.pw_gid
    except KeyError:
        # LDAP-only user — nothing we can/should do here
        print(f"[pre_spawn_hook] User {username} not in local passwd → LDAP user, skipping home creation")
        return

    if os.path.exists(home):
        print(f"[pre_spawn_hook] Home already exists: {home}")
        return

    print(f"[pre_spawn_hook] Creating home directory for local user {username}: {home}")

    # METHOD 1 (preferred — works everywhere Ubuntu/Debian ships this)
    try:
        subprocess.check_call(["mkhomedir_helper", username])
        print(f"[pre_spawn_hook] mkhomedir_helper successfully created {home}")
        return
    except (FileNotFoundError, subprocess.CalledProcessError):
        pass  # fall back gracefully

    # METHOD 2 (bulletproof fallback used by Zero-to-JupyterHub and TLJH)
    os.makedirs(home, exist_ok=True)
    try:
        subprocess.check_call(["cp", "-aT", "/etc/skel/", f"{home}/"])
        print(f"[pre_spawn_hook] cp fallback: copied /etc/skel → {home}")
    except Exception as e:
        print(f"[pre_spawn_hook] Even cp fallback failed: {e}")
        raise

    # Final ownership (mkhomedir_helper already does this, but safe to repeat)
    os.chown(home, uid, gid)
    for root, dirs, files in os.walk(home):
        for name in dirs + files:
            os.chown(os.path.join(root, name), uid, gid)

    os.chmod(home, 0o700)
    print(f"[pre_spawn_hook] Home directory fully created and owned for {username}")

# Attach the hook
c.Spawner.pre_spawn_hook = safe_ensure_home_dir

